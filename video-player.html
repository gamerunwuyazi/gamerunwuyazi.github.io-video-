
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频播放</title>
    <!-- 使用本地Video.js库 -->
    <link href="lib/video-js.min.css" rel="stylesheet">
    <script src="lib/video.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            color: white;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        /* 移动设备视频控制样式 */
        video::-webkit-media-controls {
            display: none !important;
        }
        
        video::-webkit-media-controls-play-button,
        video::-webkit-media-controls-start-playback-button {
            display: none !important;
            -webkit-appearance: none;
        }
        
        /* 确保Video.js控制栏在移动设备上正常显示 */
        @media (max-width: 768px) {
            .vjs-control-bar {
                display: flex !important;
                opacity: 1 !important;
            }
        }

        .player-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* 自定义播放器容器 */
        .custom-player {
            position: relative;
            width: 100%;
            height: 70vh;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 自定义视频容器 */
        .video-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #videoPlayer {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }
        
        /* 弹幕容器样式 - 增强移动设备兼容性 */
        .danmu-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 2147483647; /* 最高层级，确保在Video.js控件之上 */
            background: transparent;
            will-change: transform;
            -webkit-transform: translateZ(0); /* 硬件加速 */
            transform: translateZ(0);
            /* 添加动画关键帧 */
            animation-delay: 0s;
        }
        
        /* 弹幕动画 */
        @keyframes danmuSlide {
            from { transform: translateX(100%); }
            to { transform: translateX(-100%); }
        }
        
        /* 弹幕项样式 */
        .danmu-item {
            position: absolute;
            white-space: nowrap;
            font-size: 16px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            animation: danmuSlide 8s linear forwards;
            animation-play-state: running;
            z-index: 2147483647;
            pointer-events: none;
        }
        
        /* 弹幕参考容器 */
        #danmuReferenceContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            visibility: hidden;
        }
        
        /* 弹幕颜色选择器样式 */
        .danmu-color-picker {
            display: inline-flex;
            align-items: center;
            margin: 0 10px;
        }
        
        .color-label {
            font-size: 14px;
            margin-right: 8px;
            color: #333;
        }
        
        .color-options {
            display: flex;
            gap: 5px;
        }
        
        .color-option {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .color-option:hover {
            transform: scale(1.1);
        }
        
        .color-option.active {
            border-color: #333;
            box-shadow: 0 0 0 2px #fff, 0 0 0 4px #333;
        }
        
        /* 自定义播放器全屏样式 - 优化全屏体验 */
        .video-player-wrapper:fullscreen,
        .video-player-wrapper:-webkit-full-screen,
        .video-player-wrapper:-moz-full-screen,
        .video-player-wrapper:-ms-fullscreen {
            width: 100% !important;
            height: 100vh !important;
            max-width: 100% !important;
            max-height: 100% !important;
            margin: 0 !important;
            border-radius: 0 !important;
            background-color: #000 !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            z-index: 9999 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            overflow: hidden !important;
            width: 100%;
            height: 100vh;
            max-width: 100%;
            max-height: 100%;
            margin: 0;
            border-radius: 0;
            background-color: #000;
            position: relative;
        }
        
        /* 全屏模式下视频包装器样式 */
        :fullscreen .video-wrapper,
        :-webkit-full-screen .video-wrapper,
        :-moz-full-screen .video-wrapper,
        :-ms-fullscreen .video-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #000;
        }
        
        /* 全屏模式下视频元素样式 */
        :fullscreen #videoPlayer,
        :-webkit-full-screen #videoPlayer,
        :-moz-full-screen #videoPlayer,
        :-ms-fullscreen #videoPlayer {
            width: 100% !important;
            height: 100% !important;
            object-fit: contain;
            background-color: #000;
        }
        
        /* 修复全屏模式下的Video.js容器样式 */
        :fullscreen .video-wrapper,
        :-webkit-full-screen .video-wrapper,
        :-moz-full-screen .video-wrapper,
        :-ms-fullscreen .video-wrapper {
            width: 100% !important;
            height: 100% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            background-color: #000 !important;
        }
        
        /* 全屏模式下弹幕容器样式 */
        :fullscreen .danmu-container,
        :-webkit-full-screen .danmu-container,
        :-moz-full-screen .danmu-container,
        :-ms-fullscreen .danmu-container {
            width: 100%;
            height: 100%;
            z-index: 2147483647; /* 使用最大的z-index值确保在最上层 */
            background-color: transparent;
        }
        
        /* 全屏模式下参考容器样式 */
        :fullscreen #danmuReferenceContainer,
        :-webkit-full-screen #danmuReferenceContainer,
        :-moz-full-screen #danmuReferenceContainer,
        :-ms-fullscreen #danmuReferenceContainer {
            width: 100%;
            height: 100%;
        }
        
        /* 修复Video.js大播放按钮定位 */
        .vjs-big-play-button {
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            margin: 0 !important;
            z-index: 100 !important;
        }
        
        /* 自定义全屏按钮 */
        .custom-fullscreen-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 40px !important;
            height: 40px !important;
            min-width: 40px;
            min-height: 40px;
            max-width: 40px;
            max-height: 40px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        .custom-fullscreen-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .danmu-item {
            position: absolute;
            white-space: nowrap;
            font-size: 20px;
            text-shadow: 1px 1px 2px #000;
            opacity: 0.9;
            z-index: 10;
            /* 使用left属性而不是transform，确保位置计算准确 */
            animation: danmu-move 6s linear;
        }

        @keyframes danmu-move {
            0% { 
                left: 100%; /* 从容器右侧开始，100%表示容器右边缘 */
                opacity: 0; /* 开始时透明 */
            }
            5% { 
                opacity: 0.9; /* 进入视野后显示 */
            }
            95% { 
                opacity: 0.9; /* 离开视野前保持显示 */
            }
            100% { 
                left: -100%; /* 移动到容器左侧外，确保完全离开 */
                opacity: 0; /* 完全离开后透明 */
            }
        }
        
        /* CSS样式块结束 */
    </style>
    
    <script>
        // 添加全屏状态监听
        document.addEventListener('fullscreenchange', updateFullscreenButtonIcon);
        document.addEventListener('webkitfullscreenchange', updateFullscreenButtonIcon);
        document.addEventListener('mozfullscreenchange', updateFullscreenButtonIcon);
        document.addEventListener('MSFullscreenChange', updateFullscreenButtonIcon);
        
        // 修改updateFullscreenButtonIcon函数，自动检测全屏状态
        function updateFullscreenButtonIcon() {
            const isFullscreen = !!document.fullscreenElement;
            const fullscreenBtn = document.getElementById('customFullscreenBtn');
            if (!fullscreenBtn) return;
            
            if (isFullscreen) {
                // 全屏状态下显示退出全屏图标
                fullscreenBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 3 3 3 3 9"></polyline>
                        <polyline points="15 21 21 21 21 15"></polyline>
                        <line x1="3" y1="9" x2="10" y2="16"></line>
                        <line x1="21" y1="15" x2="14" y2="8"></line>
                    </svg>
                `;
            } else {
                // 非全屏状态下显示进入全屏图标
                fullscreenBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <polyline points="9 21 3 21 3 15"></polyline>
                        <line x1="21" y1="9" x2="14" y2="16"></line>
                        <line x1="3" y1="15" x2="10" y2="8"></line>
                    </svg>
                `;
            }
        }
    </script>
    
    <style>
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
            transition: background-color 0.2s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .comment-section {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .comment-form {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .comment-input {
            flex: 1;
            padding: 0.8rem;
            border: 1px solid #444;
            border-radius: 4px;
            background: #222;
            color: white;
            font-size: 14px;
        }

        .comment-submit {
            padding: 0.8rem 1.5rem;
            background: #00a1d6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .comment-submit:hover:not(:disabled) {
            background: #008cc3;
        }

        .comment-submit:disabled {
            background: #444;
            cursor: not-allowed;
        }

        .comment-list {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .comment-list::-webkit-scrollbar {
            width: 6px;
        }

        .comment-list::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        .comment-list::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }

        .comment-list::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }

        .comment-item {
            padding: 1rem;
            border-bottom: 1px solid #333;
            transition: background-color 0.2s;
        }

        .comment-item:hover {
            background: rgba(255,255,255,0.03);
        }

        .comment-content {
            margin-bottom: 0.5rem;
            word-break: break-word;
        }

        .comment-time {
            font-size: 0.8rem;
            color: #888;
        }

        .danmu-controls {
            position: absolute;
            bottom: 80px;
            right: 20px;
            display: flex;
            gap: 1rem;
            background: rgba(0,0,0,0.7);
            padding: 0.8rem;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .danmu-input {
            padding: 0.5rem;
            border: 1px solid #444;
            border-radius: 4px;
            background: #222;
            color: white;
            width: 200px;
            font-size: 14px;
        }

        .danmu-send {
            padding: 0.5rem 1rem;
            background: #00a1d6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .danmu-send:hover:not(:disabled) {
            background: #008cc3;
        }

        .danmu-send:disabled {
            background: #444;
            cursor: not-allowed;
        }
        
        /* 自定义全屏按钮样式 */
        .custom-fullscreen-btn {
            background-color: transparent;
            color: white;
            border: none;
            border-radius: 0;
            padding: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
            width: 100%;
            height: 100%;
        }
        
        .custom-fullscreen-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        /* 控制栏中自定义全屏按钮包装器样式 */
        .custom-fullscreen-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 4em;
        }

        .video-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .video-description {
            color: #ccc;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #888;
        }

        .empty-comments {
            text-align: center;
            padding: 2rem;
            color: #888;
        }
        
        /* 登录/注册模态框样式 */
        .auth-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ecf0f3;
            padding: 2rem;
            border-radius: 1rem;
            z-index: 2001;
            min-width: 400px;
            display: none;
            box-shadow: 
                6px 6px 12px #d1d9e6,
                -6px -6px 12px #ffffff;
            flex-direction: column;
        }
        
        /* 统一的关闭按钮样式 */
        .auth-modal .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.05);
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px 10px;
            border-radius: 50%;
            transition: all 0.3s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .auth-modal .close-btn:hover {
            background-color: #f0f0f0;
            color: #333;
            transform: scale(1.1);
        }
        
        /* 用户信息样式 */
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.8rem 1.2rem;
            background-color: #f0f2f5;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            font-size: 0.9rem;
        }
        
        .user-name {
            color: #333;
            font-weight: 500;
        }
        
        .logout-btn {
            padding: 0.4rem 1rem;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background-color 0.2s;
        }
        
        .logout-btn:hover {
            background-color: #d32f2f;
        }
        
        /* 删除视频按钮样式 */
        .delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
            margin-top: 1rem;
        }
        
        .delete-btn:hover {
            background-color: #c0392b;
        }
        
        .auth-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 1.5rem;
        }
        
        .auth-tab {
            flex: 1;
            padding: 0.8rem;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            border-radius: 0.5rem 0.5rem 0 0;
        }
        
        .auth-tab.active {
            color: #333;
            font-weight: 600;
            background: white;
            box-shadow: inset 2px 2px 5px #d1d9e6,
                        inset -2px -2px 5px #ffffff;
        }
        
        .auth-form {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: inset 2px 2px 5px #d1d9e6,
                        inset -2px -2px 5px #ffffff;
        }
        
        .auth-form h3 {
            margin-bottom: 1.5rem;
            text-align: center;
            color: #333;
        }
        
        /* 上传按钮样式 */
        .upload-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .upload-btn:hover {
            background-color: #2980b9;
        }

        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 1rem 2rem;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 3000;
            animation: slideIn 0.3s ease-out;
            display: none;
        }

        .message.error {
            background: #f44336;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .player-container {
                padding: 1rem;
                gap: 1rem;
            }
            
            .custom-player {
                height: 50vh;
            }
            
            .danmu-controls {
                bottom: 60px;
                right: 10px;
                left: 10px;
            }
            
            .danmu-input {
                flex: 1;
            }
            
            .comment-form {
                flex-direction: column;
            }
            
            .back-btn {
                top: 10px;
                left: 10px;
                padding: 8px 16px;
            }
            
            .custom-fullscreen-btn {
                width: 35px;
                height: 35px;
                bottom: 15px;
                right: 15px;
            }
        }

        /* 遮罩层样式 */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            cursor: pointer;
        }
        
        /* 调整模态框z-index，确保在遮罩层上方 */
        .auth-modal {
            z-index: 2001;
        }
    </style>
</head>
<body>
    <button class="back-btn" onclick="window.history.back()">返回列表</button>
    <div style="position: absolute; top: 20px; right: 20px;">
        <button id="loginBtn" class="upload-btn" onclick="toggleAuthModal(true, 'login')">登录</button>
        <div id="userInfo" class="user-info" style="display: none;"></div>
    </div>
    
    <div class="player-container">
        <!-- 自定义播放器 -->
        <div class="video-player-wrapper" id="videoPlayerWrapper">
            <div class="video-wrapper">
                <!-- 视频容器包含播放器和弹幕层 -->
                <div style="position: relative; width: 100%; height: 100%;">
                    <video crossorigin="anonymous" id="videoPlayer" class="video-js" controls preload="auto" playsinline webkit-playsinline x5-playsinline x5-video-player-type="h5" x5-video-player-fullscreen="false" x5-video-orientation="portraint" style="width: 100%; aspect-ratio: 16/9; object-fit: contain; background-color: black;">
                        <source src="https://sample-videos.com/video123/mp4/720/big_buck_bunny_720p_1mb.mp4" type="video/mp4">
                        您的浏览器不支持HTML5视频播放
                    </video>
                    <!-- 弹幕容器 -->
                    <div id="danmuContainer" class="danmu-container"></div>
                </div>
            </div>
            
            <!-- 弹幕控制区域 -->
            <div class="danmu-controls">
                <input type="text" class="danmu-input" id="danmuInput" placeholder="发送弹幕...">
                <div class="danmu-color-picker">
                    <span class="color-label">颜色:</span>
                    <div class="color-options">
                        <button class="color-option" data-color="#ffffff" style="background-color: #ffffff; border: 1px solid #ccc;"></button>
                        <button class="color-option" data-color="#ff0000" style="background-color: #ff0000;"></button>
                        <button class="color-option" data-color="#00ff00" style="background-color: #00ff00;"></button>
                        <button class="color-option" data-color="#00ffff" style="background-color: #00ffff;"></button>
                        <button class="color-option" data-color="#ff00ff" style="background-color: #ff00ff;"></button>
                        <button class="color-option" data-color="#ffff00" style="background-color: #ffff00;"></button>
                    </div>
                </div>
                <button class="danmu-send" onclick="sendDanmu()">发送</button>
                <div>提示：有颜色的弹幕自己看不见颜色</div>
            </div>
            
            <!-- 自定义全屏按钮将在Video.js初始化后添加到控制栏 -->
            <button id="customFullscreenBtn" class="custom-fullscreen-btn" onclick="toggleFullscreen()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <polyline points="9 21 3 21 3 15"></polyline>
                    <line x1="21" y1="9" x2="14" y2="16"></line>
                    <line x1="3" y1="15" x2="10" y2="8"></line>
                </svg>
            </button>
        </div>
        
        <div>
            <h1 class="video-title" id="videoTitle"></h1>
            <p class="video-description" id="videoDescription"></p>
            <div id="videoActions" style="display: none;">
                <button id="deleteVideoBtn" class="delete-btn" onclick="confirmDeleteVideo()">删除视频</button>
            </div>
        </div>
        
        <div class="comment-section">
            <h2 style="margin-bottom: 1rem;">评论区</h2>
            <div class="comment-form">
                <input type="text" class="comment-input" id="commentInput" placeholder="发表评论...">
                <button class="comment-submit" onclick="submitComment()">评论</button>
            </div>
            
            <div class="comment-list" id="commentList">
                <div class="loading">加载评论中...</div>
            </div>
        </div>
    </div>

    <div class="message" id="message"></div>

    <!-- 遮罩层 -->
    <div class="overlay" id="overlay"></div>

    <!-- 登录/注册模态框 -->
    <div class="auth-modal" id="authModal">
        <button class="close-btn" onclick="toggleAuthModal(false)">&times;</button>
        <div class="auth-tabs">
            <button id="loginTab" class="auth-tab" onclick="switchAuthTab('login')">登录</button>
            <button id="registerTab" class="auth-tab" onclick="switchAuthTab('register')">注册</button>
        </div>
        
        <!-- 登录表单 -->
        <div id="loginForm" class="auth-form">
            <h3>用户登录</h3>
            <div style="margin-bottom: 1rem;">
                <input type="text" id="loginUsername" placeholder="用户名" required style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 1.5rem;">
                <input type="password" id="loginPassword" placeholder="密码" required style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div class="modal-actions">
                <button type="button" id="loginSubmit" class="submit-btn" onclick="submitLogin()">登录</button>
            </div>
        </div>
        
        <!-- 注册表单 -->
        <div id="registerForm" class="auth-form" style="display: none;">
            <h3>用户注册</h3>
            <div style="margin-bottom: 1rem;">
                <input type="text" id="registerUsername" placeholder="用户名（4-20个字符）" required style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 1rem;">
                <input type="password" id="registerPassword" placeholder="密码（至少6个字符）" required style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 1.5rem;">
                <input type="text" id="registerNickname" placeholder="昵称" required style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div class="modal-actions">
                <button type="button" id="registerSubmit" class="submit-btn" onclick="submitRegister()">注册</button>
            </div>
        </div>
    </div>

    <script>
        // 设置后端API基础URL为用户指定的地址
        const API_BASE = 'https://video-dns.wu.airoe.cn';
        const DEFAULT_COVER = 'https://picsum.photos/400/300';
        let videoId = null;
        let videoData = null;
        let danmus = [];
        let comments = [];
        let lastDanmuCheck = null; // 跟踪上次弹幕检查时间
        let danmuIdCounter = 0;
        let currentUser = null;

        // Video.js播放器对象
        let player = null;
        
        // 使用videojs-danmaku插件的Video.js初始化
        function initVideoPlayer() {
            // 检查videojs是否已加载
            if (typeof videojs === 'undefined') {
                console.error('Video.js 未成功加载');
                // 尝试使用原生video元素作为回退
                initNativeVideoPlayer();
                return;
            }
            
            // 设置中文语言包
            if (videojs.addLanguage) {
                videojs.addLanguage('zh-CN', {
                    Play: "播放",
                    Pause: "暂停",
                    Mute: "静音",
                    Unmute: "取消静音"
                });
            }
            
            // 初始化播放器，禁用双击放大功能并添加移动设备配置
            player = videojs('videoPlayer', {
                controls: true,
                autoplay: false,
                preload: 'auto',
                language: 'zh-CN',
                responsive: true,
                bigPlayButton: true,
                disableContextMenu: true, // 禁用右键菜单
                userActions: {
                    doubleClick: false // 禁用双击放大
                },
                controlBar: {
                    fullscreenToggle: false // 禁用默认全屏按钮
                },
                // 移动设备相关配置
                nativeControlsForTouch: false, // 禁用原生触摸控制
                inactivityTimeout: 0, // 防止控制栏自动隐藏
                techOrder: ['html5'], // 优先使用HTML5播放器
                html5: {
                    nativeAudioTracks: false,
                    nativeVideoTracks: false,
                    nativeTextTracks: false
                }
            });
            
            console.log('Video.js播放器初始化完成');
            
            // 移动设备额外控制
            if (player && player.tech_) {
                const tech = player.tech_;
                
                // 监听播放事件，防止系统接管
                player.on('play', function() {
                    if (tech && tech.el_) {
                        // 强制保持内联播放模式
                        tech.el_.setAttribute('playsinline', 'true');
                        tech.el_.setAttribute('webkit-playsinline', 'true');
                        tech.el_.setAttribute('x5-playsinline', 'true');
                    }
                });
                
                // 处理触摸事件 - 不再阻止所有默认行为，以允许进度条点击
                if (window.TouchEvent) {
                    // 移除全局阻止默认行为的代码，让进度条可以正常响应点击
                    // 如果需要针对特定区域阻止默认行为，可以在具体元素上单独处理
                }
                
                // 针对iOS设备的特殊处理
                if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) {
                    // 确保Video.js控制栏始终可见
                    player.controlBar.show();
                    player.controlBar.el_.style.display = 'flex';
                    player.controlBar.el_.style.opacity = '1';
                }
            }
            
            // 修复进度条点击问题：确保进度条点击时正确设置视频时间
            setTimeout(function() {
                try {
                    const progressControl = player.controlBar.progressControl;
                    if (progressControl && progressControl.el_) {
                        const progressEl = progressControl.el_;
                        
                        // 保存原始的点击处理函数
                        const originalClickHandler = progressEl.onclick;
                        
                        // 添加自定义点击处理，确保正确计算点击位置的时间
                        progressEl.addEventListener('click', function(e) {
                            // 阻止事件冒泡，防止可能的冲突
                            e.stopPropagation();
                            
                            // 获取进度条元素的位置和尺寸
                            const rect = progressEl.getBoundingClientRect();
                            const clickX = e.clientX - rect.left;
                            const progressBarWidth = rect.width;
                            
                            // 计算点击位置对应的视频时间比例
                            const seekPercent = clickX / progressBarWidth;
                            
                            // 确保比例在0-1之间
                            const clampedPercent = Math.max(0, Math.min(1, seekPercent));
                            
                            // 获取视频总时长并计算目标时间
                            const duration = player.duration();
                            const targetTime = duration * clampedPercent;
                            
                            console.log('自定义进度条点击处理:', {
                                clickX: clickX,
                                width: progressBarWidth,
                                percent: clampedPercent,
                                duration: duration,
                                targetTime: targetTime
                            });
                            
                            // 直接设置视频时间
                            player.currentTime(targetTime);
                        });
                    }
                } catch (error) {
                    console.error('设置自定义进度条点击处理失败:', error);
                }
            }, 1000);
            
            // 禁用Video.js默认的全屏按钮并集成自定义全屏按钮到控制栏
            setTimeout(function() {
                try {
                    // 禁用默认全屏按钮
                    const defaultFullscreenBtn = player.getChild('controlBar').getChild('fullscreenToggle');
                    if (defaultFullscreenBtn) {
                        defaultFullscreenBtn.dispose(); // 完全移除默认按钮
                    }
                    
                    // 获取自定义全屏按钮
                    const customFullscreenBtn = document.getElementById('customFullscreenBtn');
                    if (customFullscreenBtn) {
                        // 移除原有的绝对定位样式
                        customFullscreenBtn.style.position = 'static';
                        customFullscreenBtn.style.bottom = 'auto';
                        customFullscreenBtn.style.right = 'auto';
                        customFullscreenBtn.style.zIndex = 'auto';
                        customFullscreenBtn.style.width = 'auto';
                        customFullscreenBtn.style.height = 'auto';
                        
                        // 获取控制栏
                        const controlBar = player.getChild('controlBar').el();
                        
                        // 创建一个包装器来放置自定义按钮
                        const customFullscreenWrapper = document.createElement('div');
                        customFullscreenWrapper.className = 'vjs-control vjs-button custom-fullscreen-wrapper';
                        customFullscreenWrapper.appendChild(customFullscreenBtn);
                        
                        // 将自定义按钮添加到控制栏的最右侧
                        controlBar.appendChild(customFullscreenWrapper);
                    }
                } catch (error) {
                    console.error('无法修改Video.js控制栏:', error);
                }
            }, 500);
            
            // 添加必要的事件监听以支持弹幕功能
            player.on('loadedmetadata', function() {
                console.log('视频已加载');
                resetDanmuLines();
            });
            
            player.on('play', function() {
                console.log('视频开始播放');
                resumeDanmus();
            });
            
            player.on('pause', function() {
                console.log('视频暂停');
                pauseDanmus();
            });
            
            // 监听Video.js全屏事件
            player.on('fullscreenchange', function() {
                console.log('Video.js全屏状态改变:', player.isFullscreen());
                // 全屏变化时重新调整弹幕容器
                setTimeout(() => {
                    resetDanmuLines();
                }, 100);
            });
            
            player.on('seeking', function() {
                const currentTime = player.currentTime();
                console.log('视频开始跳转，当前时间:', currentTime);
            });
            
            player.on('seeked', function() {
                const newTime = player.currentTime();
                console.log('视频跳转完成，新时间:', newTime);
                resetDanmuLines();
                clearAllDanmus();
                showDanmus();
            });
            
            player.on('timeupdate', function() {
                showDanmus();
            });
            
            player.on('error', function() {
                console.error('Video.js播放错误:', player.error());
            });
        }
        
        // 更新弹幕显示的函数
        function updateDanmus() {
            showDanmus();
        }
        
        // 视频时间格式化函数
        function formatTime(seconds) {
            if (isNaN(seconds)) return '00:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        // 加载视频源的函数，适配Video.js
        function loadVideoSource(src) {
            if (player) {
                player.src(src);
                player.load();
            }
        }
            
        // 全局变量存储弹幕控制函数，避免作用域问题
        let showDanmuControls = null;
        
        // 增强版全屏变化处理函数 - 适配Video.js播放器
        function handleFullscreenChange() {
            const isFullscreen = !!document.fullscreenElement || 
                               !!document.webkitFullscreenElement || 
                               !!document.mozFullScreenElement || 
                               !!document.msFullscreenElement;
            
            // 更新全屏按钮图标
            updateFullscreenButtonIcon(isFullscreen);
            
            // 更新弹幕容器样式，确保在全屏时正确显示
            const danmuContainer = document.getElementById('danmuContainer');
            if (danmuContainer) {
                // 确保弹幕容器在全屏时有正确的样式
                danmuContainer.style.position = 'absolute';
                danmuContainer.style.top = '0';
                danmuContainer.style.left = '0';
                danmuContainer.style.width = '100%';
                danmuContainer.style.height = '100%';
                danmuContainer.style.pointerEvents = 'none';
                danmuContainer.style.zIndex = '2147483647'; // 确保在Video.js播放器上层
                
                // 不重新加载弹幕或重置弹幕行，保留当前显示状态
                // 强制重排以确保样式生效
                danmuContainer.offsetHeight;
            }
            
            // 只更新弹幕位置和样式，不重置动画
            const danmuElements = document.querySelectorAll('.danmu-item');
            danmuElements.forEach(element => {
                // 确保弹幕在最上层
                element.style.zIndex = '2147483647';
                // 不重新开始动画，避免弹幕重置
            });
            
            // 重新显示当前时间点的弹幕，无论使用哪种播放器
            showDanmus();
            
            // 控制弹幕输入区域在全屏模式下的显示/隐藏
            const danmuControls = document.querySelector('.danmu-controls');
            if (danmuControls) {
                if (isFullscreen) {
                    // 全屏模式下默认隐藏弹幕控制区域
                    danmuControls.style.opacity = '0';
                    danmuControls.style.transition = 'opacity 0.3s ease';
                    
                    // 定义显示控制区域的函数
                    showDanmuControls = function() {
                        danmuControls.style.opacity = '1';
                        
                        // 清除之前的定时器
                        if (window.hideControlsTimer) {
                            clearTimeout(window.hideControlsTimer);
                        }
                        
                        // 设置定时器，在鼠标停止移动2秒后隐藏控制区域
                        window.hideControlsTimer = setTimeout(function() {
                            if (!!document.fullscreenElement || 
                                !!document.webkitFullscreenElement || 
                                !!document.mozFullScreenElement || 
                                !!document.msFullscreenElement) {
                                danmuControls.style.opacity = '0';
                            }
                        }, 2000);
                    };
                    
                    // 移除之前的事件监听器，避免重复添加
                    if (showDanmuControls) {
                        document.removeEventListener('mousemove', showDanmuControls);
                    }
                    document.addEventListener('mousemove', showDanmuControls);
                } else {
                    // 非全屏模式下显示弹幕控制区域
                    danmuControls.style.opacity = '1';
                    // 移除事件监听器
                    if (showDanmuControls) {
                        document.removeEventListener('mousemove', showDanmuControls);
                    }
                    if (window.hideControlsTimer) {
                        clearTimeout(window.hideControlsTimer);
                    }
                }
            }
        }
        
        // 初始化播放器
        async function initPlayer() {
            videoId = new URLSearchParams(window.location.search).get('id');
            if (!videoId) {
                showMessage('无效的视频ID', true);
                return;
            }
            
            // 检查用户登录状态
            await checkLoginStatus();
            
            // 初始化Video.js播放器
            initVideoPlayer();
            
            // 监听全屏变化事件
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
            document.addEventListener('mozfullscreenchange', handleFullscreenChange);
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('MSFullscreenChange', handleFullscreenChange);
            
            // 视频已准备就绪，Video.js会自动处理加载状态
            
            try {
                // 显示加载状态
                document.getElementById('commentList').innerHTML = '<div class="loading">加载中...</div>';
                
                // 获取视频信息，包含用户ID以便判断是否为视频所有者和显示上传者昵称
                const response = await fetch(`${API_BASE}/api/videos/${videoId}`);
                const { code, data } = await response.json();
                
                if (code === 200) {
                    videoData = data;
                    document.title = data.title + ' - 视频分享平台';
                    // 使用Video.js加载视频
                    loadVideoSource(data.video_path);
                    document.getElementById('videoTitle').textContent = data.title;
                    
                    // 显示视频描述和上传者昵称
                    // 修复双重转义问题：创建DOM元素而不是直接拼接HTML
                    const videoDescElement = document.getElementById('videoDescription');
                    videoDescElement.innerHTML = '';
                    
                    // 创建描述段落
                    const descPara = document.createElement('p');
                    descPara.textContent = data.description || '暂无描述';
                    videoDescElement.appendChild(descPara);
                    
                    // 创建上传者信息段落
                    const uploaderPara = document.createElement('p');
                    uploaderPara.style.marginTop = '0.8rem';
                    uploaderPara.style.color = '#00a1d6';
                    uploaderPara.style.fontWeight = 'bold';
                    uploaderPara.textContent = data.nickname ? `上传者：${data.nickname}` : '上传者：匿名用户';
                    videoDescElement.appendChild(uploaderPara);
                    
                    // 加载弹幕和评论（并行加载以提高性能）
                    await Promise.all([loadDanmus(), loadComments()]);
                    
                    // 检查当前用户是否为视频所有者
                    checkVideoOwnership();
                } else {
                    throw new Error('视频加载失败');
                }
            } catch (error) {
                showMessage('视频加载失败: ' + error.message, true);
                // 3秒后返回首页
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
            }
        }
        
        // 检查视频所有者
        async function checkVideoOwnership() {
            if (!currentUser) {
                document.getElementById('videoActions').style.display = 'none';
                return;
            }
            
            try {
                // 获取更详细的视频信息，包含user_id
                const response = await fetch(`${API_BASE}/api/videos/${videoId}`, {
                    headers: {
                        'Authorization': localStorage.getItem('authToken') ? `Bearer ${localStorage.getItem('authToken')}` : ''
                    }
                });
                
                const { code, data } = await response.json();
                if (code === 200 && data.user_id && data.user_id === currentUser.id) {
                    document.getElementById('videoActions').style.display = 'block';
                } else {
                    document.getElementById('videoActions').style.display = 'none';
                }
            } catch (error) {
                console.error('检查视频所有权失败:', error);
                document.getElementById('videoActions').style.display = 'none';
            }
        }
        
        // 确认删除视频
        function confirmDeleteVideo() {
            if (confirm('确定要删除这个视频吗？此操作不可恢复，视频和封面文件将被永久删除。')) {
                deleteVideo();
            }
        }
        
        // 删除视频
        async function deleteVideo() {
            const deleteBtn = document.getElementById('deleteVideoBtn');
            try {
                deleteBtn.disabled = true;
                deleteBtn.textContent = '删除中...';
                
                const token = localStorage.getItem('authToken');
                
                // 第一步：删除实际的视频文件和封面文件
                const deleteFilesResponse = await fetch(`${API_BASE}/api/videos/${videoId}/files`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });
                
                const deleteFilesResult = await deleteFilesResponse.json();
                if (deleteFilesResult.code !== 200) {
                    console.warn('删除文件失败，但继续删除视频元数据:', deleteFilesResult.msg);
                    // 这里不抛出错误，继续执行元数据删除
                }
                
                // 第二步：删除视频元数据
                const response = await fetch(`${API_BASE}/api/videos/${videoId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });
                
                const result = await response.json();
                if (result.code === 200) {
                    // 发送WebSocket消息通知其他用户
                    // 首先尝试初始化WebSocket连接（如果不存在）
                    let ws;
                    try {
                        // 创建临时WebSocket连接发送删除消息
                        const WS_BASE = 'ws://152.136.175.209:3002';
                        ws = new WebSocket(WS_BASE);
                        
                        // 设置超时确保消息发送
                        setTimeout(() => {
                            if (ws && ws.readyState === WebSocket.OPEN) {
                                const displayName = currentUser.nickname && currentUser.nickname.trim() !== '' 
                                    ? currentUser.nickname 
                                    : (currentUser.username || '用户');
                                
                                ws.send(JSON.stringify({
                                    type: 'VIDEO_DELETED',
                                    data: {
                                        videoId: videoId,
                                        deleter: displayName
                                    }
                                }));
                                
                                // 发送后关闭连接
                                ws.close();
                            }
                        }, 500);
                    } catch (wsError) {
                        console.warn('发送WebSocket消息失败，可能不影响主要功能:', wsError);
                    }
                    
                    showMessage('视频删除成功，文件已清理');
                    // 2秒后返回视频列表
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                } else {
                    throw new Error(result.msg || '删除失败');
                }
            } catch (error) {
                showMessage('视频删除失败: ' + error.message, true);
            } finally {
                deleteBtn.disabled = false;
                deleteBtn.textContent = '删除视频';
            }
        }

        // 加载弹幕
        async function loadDanmus() {
            try {
                // 从API加载弹幕
                const response = await fetch(`${API_BASE}/api/danmus?video_id=${videoId}`);
                const { code, data } = await response.json();
                
                if (code === 200) {
                    danmus = data || [];
                    console.log('弹幕加载成功，共', danmus.length, '条弹幕');
                } else {
                    danmus = [];
                    console.log('API返回错误，没有加载弹幕');
                }
                
                // 确保弹幕容器已初始化
                if (!danmuContainer) {
                    initDanmuContainer();
                }
                
                // 重置弹幕行状态
                resetDanmuLines();
                
            } catch (error) {
                console.error('弹幕加载失败:', error);
                showMessage('弹幕加载失败', true);
                danmus = [];
                
                // 确保弹幕容器已初始化
                if (!danmuContainer) {
                    initDanmuContainer();
                }
                
                // 重置弹幕行状态
                resetDanmuLines();
            }
        }
        
        // 初始化弹幕容器
        function initDanmuContainer() {
            danmuContainer = document.getElementById('danmuContainer');
            if (danmuContainer) {
                console.log('弹幕容器已初始化');
                // 设置弹幕容器样式
                danmuContainer.style.position = 'absolute';
                danmuContainer.style.top = '0';
                danmuContainer.style.left = '0';
                danmuContainer.style.width = '100%';
                danmuContainer.style.height = '100%';
                danmuContainer.style.pointerEvents = 'none';
                danmuContainer.style.zIndex = '1000'; // 确保在Video.js控制层下方
            } else {
                console.error('未找到弹幕容器');
            }
        }

        // 显示弹幕
        function showDanmus() {
            const currentTime = player ? player.currentTime() : 0;
            const container = document.getElementById('danmuContainer');
            
            // 显示当前时间点的弹幕（不清除旧弹幕，让它们自然消失）
            danmus.forEach(danmu => {
                // 允许有一定的时间误差，不使用displayed标记，确保回退时能重新显示
                if (Math.abs(danmu.time - currentTime) < 0.5) {
                    // 检查是否已经有这个弹幕正在显示
                    const existingDanmu = document.querySelector(`[data-danmu-id="${danmu.id || 'temp_' + Date.now()}"]`);
                    if (!existingDanmu) {
                        showDanmuItem(danmu);
                    }
                }
            });
        }

        // 弹幕行管理
        let danmuLines = [];
        const MAX_LINES = 5; // 最多5行弹幕
        const LINE_HEIGHT = 20; // 每行高度百分比
        
        // 重置弹幕行状态
        function resetDanmuLines() {
            danmuLines = [];
            for (let i = 0; i < MAX_LINES; i++) {
                danmuLines.push({
                    top: i * LINE_HEIGHT + 5, // 5% 的顶部边距，从顶部开始排列
                    currentLength: 0, // 当前行已使用的长度
                    activeDanmus: [] // 当前行活跃的弹幕
                });
            }
        }
        
        // 初始化弹幕行
        resetDanmuLines();
        
        // 计算弹幕文本的宽度
        function calculateDanmuWidth(danmuElement) {
            // 创建一个临时元素用于测量
            const tempElement = document.createElement('div');
            tempElement.style.position = 'absolute';
            tempElement.style.visibility = 'hidden';
            tempElement.style.whiteSpace = 'nowrap';
            tempElement.style.fontSize = getComputedStyle(danmuElement).fontSize;
            tempElement.style.fontFamily = getComputedStyle(danmuElement).fontFamily;
            tempElement.textContent = danmuElement.textContent;
            document.body.appendChild(tempElement);
            
            const width = tempElement.offsetWidth;
            document.body.removeChild(tempElement);
            return width;
        }
        
        // 查找合适的行来放置弹幕
        function findSuitableLine(danmuWidth) {
            // 使用参考容器来获取准确的容器宽度
            const referenceContainer = document.getElementById('danmuReferenceContainer');
            const container = document.getElementById('danmuContainer');
            // 优先使用参考容器的宽度，如果没有则回退到弹幕容器
            const containerWidth = referenceContainer ? referenceContainer.offsetWidth : container.offsetWidth;
            const safetyMargin = 100; // 安全边距，确保弹幕不会太拥挤
            const danmuSpacing = 30; // 弹幕之间的间隙宽度（像素）
            
            // 遍历所有行，找到第一个可以容纳新弹幕的行
            for (let i = 0; i < danmuLines.length; i++) {
                const line = danmuLines[i];
                // 检查当前行剩余空间是否足够容纳新弹幕和间隙
                const requiredSpace = line.currentLength > 0 ? 
                    danmuWidth + danmuSpacing : 
                    danmuWidth; // 如果是该行第一个弹幕，则不需要额外间隙
                
                if (line.currentLength + requiredSpace + safetyMargin < containerWidth) {
                    return i;
                }
            }
            
            // 如果所有行都不够，返回第一行（会覆盖之前的弹幕）
            return 0;
        }
        
        // 使用Video.js内置的全屏功能替代自定义全屏
        function toggleCustomFullscreen() {
            if (player) {
                if (player.isFullscreen()) {
                    player.exitFullscreen();
                } else {
                    player.requestFullscreen();
                }
            }
        }
        
        // 切换全屏功能
        function toggleFullscreen() {
            // 使用正确的容器ID而不是不存在的类名
            const playerWrapper = document.getElementById('videoPlayerWrapper');
            
            if (!document.fullscreenElement) {
                // 进入全屏
                if (playerWrapper && playerWrapper.requestFullscreen) {
                    playerWrapper.requestFullscreen();
                } else if (playerWrapper && playerWrapper.webkitRequestFullscreen) {
                    playerWrapper.webkitRequestFullscreen();
                } else if (playerWrapper && playerWrapper.mozRequestFullScreen) {
                    playerWrapper.mozRequestFullScreen();
                } else if (playerWrapper && playerWrapper.msRequestFullscreen) {
                    playerWrapper.msRequestFullscreen();
                } else {
                    console.error('Fullscreen API not supported or container not found');
                }
            } else {
                // 退出全屏
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                } else {
                    console.error('Fullscreen exit API not supported');
                }
            }
        }
        
        // 更新全屏按钮图标
        function updateFullscreenButtonIcon(isFullscreen) {
            const fullscreenBtn = document.getElementById('customFullscreenBtn');
            if (!fullscreenBtn) return; // Skip if button doesn't exist
            
            if (isFullscreen) {
                // 全屏状态下显示退出全屏图标
                fullscreenBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 3 3 3 3 9"></polyline>
                        <polyline points="15 21 21 21 21 15"></polyline>
                        <line x1="3" y1="9" x2="10" y2="16"></line>
                        <line x1="21" y1="15" x2="14" y2="8"></line>
                    </svg>
                `;
            } else {
                // 非全屏状态下显示进入全屏图标
                fullscreenBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <polyline points="9 21 3 21 3 15"></polyline>
                        <line x1="21" y1="3" x2="14" y2="10"></line>
                        <line x1="3" y1="21" x2="10" y2="14"></line>
                    </svg>
                `;
            }
        }
        
        // 显示单个弹幕
        function showDanmuItem(danmu) {
            const container = document.getElementById('danmuContainer');
            const danmuElement = document.createElement('div');
            danmuElement.className = 'danmu-item';
            danmuElement.textContent = danmu.content;
            danmuElement.style.color = danmu.color || '#fff';
            
            // 随机调整弹幕大小，增加视觉变化
            const randomSize = 16 + Math.random() * 8; // 16px - 24px
            danmuElement.style.fontSize = `${randomSize}px`;
            
            // 计算弹幕宽度
            const danmuWidth = calculateDanmuWidth(danmuElement);
            
            // 查找合适的行
            const lineIndex = findSuitableLine(danmuWidth);
            const line = danmuLines[lineIndex];
            
            // 设置弹幕位置
            danmuElement.style.top = `${line.top}%`;
            
            // 更新行的当前长度，包括弹幕之间的间隙
            const danmuSpacing = 30; // 弹幕之间的间隙宽度（像素）
            const addSpacing = line.currentLength > 0 ? danmuSpacing : 0;
            line.currentLength += danmuWidth + addSpacing;
            const danmuId = danmu.id || 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            line.activeDanmus.push(danmuId);
            
            // 为每个弹幕设置唯一标识
            danmuElement.setAttribute('data-danmu-id', danmuId);
            
            // 添加动画结束事件监听，自动移除元素并释放行空间
            danmuElement.addEventListener('animationend', function() {
                if (danmuElement.parentNode) {
                    danmuElement.parentNode.removeChild(danmuElement);
                    
                    // 释放该行的空间
                    for (let i = 0; i < danmuLines.length; i++) {
                        const line = danmuLines[i];
                        const index = line.activeDanmus.indexOf(danmuId);
                        if (index !== -1) {
                            line.activeDanmus.splice(index, 1);
                            // 重新计算行的当前长度（简化处理）
                            if (line.activeDanmus.length === 0) {
                                line.currentLength = 0;
                            }
                            break;
                        }
                    }
                }
            });
            
            // 确保视频准备好后再播放弹幕动画
            container.appendChild(danmuElement);
            
            // 如果视频还没准备好，暂停弹幕动画
            // 检查Video.js播放器就绪状态
            if (player && player.readyState() < 2) { // HAVE_CURRENT_DATA
                danmuElement.style.animationPlayState = 'paused';
                
                // 监听Video.js播放器可以播放事件，恢复弹幕动画
                const resumeAnimation = function() {
                    danmuElement.style.animationPlayState = 'running';
                    player.off('canplay', resumeAnimation);
                };
                player.on('canplay', resumeAnimation);
            }
            
            // 确保弹幕在全屏模式下显示正确
            const updateForFullscreen = function() {
                const isFullscreen = !!document.fullscreenElement || 
                                   !!document.webkitFullscreenElement || 
                                   !!document.mozFullScreenElement || 
                                   !!document.msFullscreenElement;
                
                if (danmuElement.parentNode) {
                    // 无论是否全屏，都设置为最高z-index
                    danmuElement.style.zIndex = '2147483647';
                    danmuElement.style.pointerEvents = 'none';
                    
                    // 重新应用动画以适应容器大小变化
                    const computedStyle = window.getComputedStyle(danmuElement);
                    const animationDuration = parseFloat(computedStyle.animationDuration) || 6;
                    const animationDelay = parseFloat(computedStyle.animationDelay) || 0;
                    const animationName = computedStyle.animationName;
                    const animationPlayState = computedStyle.animationPlayState;
                    const currentColor = computedStyle.color; // 保存当前颜色
                    
                    // 临时移除动画并触发重排
                    danmuElement.style.animation = 'none';
                    danmuElement.offsetHeight; // 触发重排
                    
                    // 重新应用动画，确保使用left属性而非transform
                    danmuElement.style.animation = `${animationName} ${animationDuration}s linear ${animationDelay}s`;
                    danmuElement.style.animationPlayState = animationPlayState;
                    // 重新设置颜色，确保不丢失
                    danmuElement.style.color = currentColor;
                }
            };
            
            // 添加全屏事件监听器
            document.addEventListener('webkitfullscreenchange', updateForFullscreen);
            document.addEventListener('mozfullscreenchange', updateForFullscreen);
            document.addEventListener('fullscreenchange', updateForFullscreen);
            document.addEventListener('MSFullscreenChange', updateForFullscreen);
            
            // 在弹幕动画结束时移除监听器
            danmuElement.addEventListener('animationend', function() {
                document.removeEventListener('webkitfullscreenchange', updateForFullscreen);
                document.removeEventListener('mozfullscreenchange', updateForFullscreen);
                document.removeEventListener('fullscreenchange', updateForFullscreen);
                document.removeEventListener('MSFullscreenChange', updateForFullscreen);
            });
        }

        // 暂停所有弹幕动画
        function pauseDanmus() {
            const danmuElements = document.querySelectorAll('.danmu-item');
            danmuElements.forEach(element => {
                // 暂停动画
                element.style.animationPlayState = 'paused';
            });
        }

        // 恢复所有弹幕动画
        function resumeDanmus() {
            const danmuElements = document.querySelectorAll('.danmu-item');
            danmuElements.forEach(element => {
                // 恢复动画
                element.style.animationPlayState = 'running';
            });
        }
        
        // 清空弹幕容器
        function clearAllDanmus() {
            const container = document.getElementById('danmuContainer');
            container.innerHTML = '';
            
            // 重置所有行状态
            danmuLines.forEach(line => {
                line.currentLength = 0;
                line.activeDanmus = [];
            });
        }

        // 当视频进度跳转时，清除当前弹幕并显示新位置的弹幕
        function onSeeked() {
            // 清除当前所有弹幕
            const container = document.getElementById('danmuContainer');
            container.innerHTML = '';
            
            // 重置弹幕行状态
            resetDanmuLines();
            
            // 显示当前时间点的弹幕
            showDanmus();
            
            // 如果Video.js播放器是暂停状态，确保弹幕也是暂停的
            if (player && player.paused()) {
                setTimeout(pauseDanmus, 10); // 延迟暂停，确保新弹幕已经开始动画
            }
        }

        // 当前选中的弹幕颜色，默认白色
        let selectedDanmuColor = '#ffffff';
        
        // 初始化颜色选择器
        function initColorPicker() {
            const colorOptions = document.querySelectorAll('.color-option');
            
            // 设置默认选中的颜色（白色）
            const defaultColor = document.querySelector('.color-option[data-color="#ffffff"]');
            if (defaultColor) {
                defaultColor.classList.add('active');
            }
            
            // 添加颜色选择事件
            colorOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // 移除所有颜色选项的active状态
                    colorOptions.forEach(opt => opt.classList.remove('active'));
                    // 为当前选中的颜色添加active状态
                    this.classList.add('active');
                    // 更新选中的颜色
                    selectedDanmuColor = this.getAttribute('data-color');
                });
            });
        }
        
        // 在页面加载完成后初始化颜色选择器
        document.addEventListener('DOMContentLoaded', function() {
            // 等待DOM元素加载完成后初始化颜色选择器
            setTimeout(initColorPicker, 100);
        });
        
        // 发送弹幕
        async function sendDanmu() {
            const input = document.getElementById('danmuInput');
            const content = input.value.trim();
            const sendBtn = document.querySelector('.danmu-send');
            
            if (!content) {
                showMessage('弹幕内容不能为空', true);
                return;
            }
            
            try {
                sendBtn.disabled = true;
                sendBtn.textContent = '发送中...';
                
                // 使用用户选择的颜色
                const color = selectedDanmuColor;
                
                // 使用自定义弹幕实现发送弹幕
                const video = document.getElementById('videoPlayer');
                const newDanmu = {
                    id: 'temp_' + Date.now(), // 临时ID
                    content: content,
                    time: video.currentTime,
                    color: color,
                    created_at: new Date().toISOString()
                };
                
                // 立即显示新发送的弹幕
                showDanmuItem(newDanmu);
                
                // 添加到弹幕数组，确保回看时能显示
                danmus.push(newDanmu);
                
                // 模拟发送到服务器（保留原有的服务器交互逻辑）
                const response = await fetch(`${API_BASE}/api/danmus`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        video_id: videoId,
                        content: content,
                        time: video.currentTime,
                        color: color
                    })
                });
                
                const result = await response.json();
                if (result.code === 200) {
                    input.value = '';
                    showMessage('弹幕发送成功');
                } else {
                    throw new Error(result.msg);
                }
            } catch (error) {
                showMessage('弹幕发送失败: ' + error.message, true);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = '发送';
            }
        }

        // 加载评论
        async function loadComments() {
            try {
                const response = await fetch(`${API_BASE}/api/comments?video_id=${videoId}`);
                const { code, data } = await response.json();
                
                if (code === 200) {
                    comments = data;
                    renderComments();
                }
            } catch (error) {
                console.error('评论加载失败:', error);
                showMessage('评论加载失败', true);
                document.getElementById('commentList').innerHTML = '<div class="empty-comments">评论加载失败</div>';
            }
        }

        // 渲染评论
        function renderComments() {
            const container = document.getElementById('commentList');
            
            container.innerHTML = ''; // 清空容器
            
            if (comments.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-comments';
                emptyDiv.textContent = '暂无评论，快来发表第一条评论吧！';
                container.appendChild(emptyDiv);
                return;
            }
            
            // 使用DOM方法创建评论元素，避免双重转义
            comments.forEach(comment => {
                const commentItem = document.createElement('div');
                commentItem.className = 'comment-item';
                
                // 创建评论作者
                const authorDiv = document.createElement('div');
                authorDiv.className = 'comment-author';
                authorDiv.style.fontWeight = 'bold';
                authorDiv.style.color = '#00a1d6';
                authorDiv.style.marginBottom = '0.3rem';
                authorDiv.textContent = comment.nickname || '匿名用户';
                commentItem.appendChild(authorDiv);
                
                // 创建评论内容
                const contentDiv = document.createElement('div');
                contentDiv.className = 'comment-content';
                contentDiv.textContent = comment.content;
                commentItem.appendChild(contentDiv);
                
                // 创建评论时间
                const timeDiv = document.createElement('div');
                timeDiv.className = 'comment-time';
                timeDiv.textContent = new Date(comment.created_at).toLocaleString();
                commentItem.appendChild(timeDiv);
                
                container.appendChild(commentItem);
            });
        }

        // 检查登录状态
        async function checkLoginStatus() {
            try {
                // 从localStorage获取token
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/api/users/profile`, {
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });
                
                const result = await response.json();
                if (result.code === 200) {
                    currentUser = result.data;
                    updateAuthUI();
                } else {
                    currentUser = null;
                    updateAuthUI();
                }
            } catch (error) {
                console.error('检查登录状态失败:', error);
                currentUser = null;
                updateAuthUI();
            }
        }
        
        // 更新认证UI
        function updateAuthUI() {
            const loginBtn = document.getElementById('loginBtn');
            const userInfo = document.getElementById('userInfo');
            
            if (currentUser) {
                // 确保登录按钮完全隐藏
                if (loginBtn) {
                    loginBtn.style.display = 'none';
                    loginBtn.style.visibility = 'hidden';
                }
                if (userInfo) {
                    // 添加nickname容错处理，确保显示有效的用户名
                    const displayName = currentUser.nickname && currentUser.nickname.trim() !== '' 
                        ? currentUser.nickname 
                        : (currentUser.username || '用户');
                    
                    // 修复双重转义问题：使用DOM方法创建元素
                    userInfo.innerHTML = '';
                    userInfo.style.display = 'flex';
                    userInfo.style.alignItems = 'center';
                    userInfo.style.gap = '0.5rem';
                    userInfo.style.fontWeight = 'bold';
                    
                    // 创建用户名元素
                    const userNameSpan = document.createElement('span');
                    userNameSpan.className = 'user-name';
                    userNameSpan.textContent = displayName;
                    userInfo.appendChild(userNameSpan);
                    
                    // 创建退出按钮
                    const logoutBtn = document.createElement('button');
                    logoutBtn.id = 'logoutBtn';
                    logoutBtn.className = 'logout-btn';
                    logoutBtn.textContent = '退出';
                    userInfo.appendChild(logoutBtn);
                    
                    // 移除之前可能存在的事件监听器，避免重复绑定
                    if (logoutBtn) {
                        // 添加样式使退出按钮更明显
                        logoutBtn.style.backgroundColor = '#27ae60';
                        logoutBtn.style.color = '#ffffff';
                        logoutBtn.style.padding = '0.5rem 1rem';
                        logoutBtn.style.border = 'none';
                        logoutBtn.style.borderRadius = '6px';
                        logoutBtn.style.cursor = 'pointer';
                        logoutBtn.style.fontWeight = 'bold';
                        
                        // 使用事件委托或移除旧监听器
                        const newLogoutBtn = logoutBtn.cloneNode(true);
                        logoutBtn.parentNode.replaceChild(newLogoutBtn, logoutBtn);
                        newLogoutBtn.addEventListener('click', logout);
                    }
                }
            } else {
                // 未登录状态下显示登录按钮
                if (loginBtn) {
                    loginBtn.style.display = 'block';
                    loginBtn.style.visibility = 'visible';
                }
                if (userInfo) {
                    userInfo.style.display = 'none';
                }
            }
        }
        
        // 切换认证模态框
        function toggleAuthModal(show, tab = 'login') {
            const modal = document.getElementById('authModal');
            const overlay = document.getElementById('overlay');
            if (!modal || !overlay) return;
            
            if (show !== undefined) {
                modal.style.display = show ? 'flex' : 'none';
                overlay.style.display = show ? 'block' : 'none';
                if (show) {
                    switchAuthTab(tab);
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                }
            } else {
                const isVisible = modal.style.display === 'flex';
                modal.style.display = isVisible ? 'none' : 'flex';
                overlay.style.display = isVisible ? 'none' : 'block';
                document.body.style.overflow = isVisible ? '' : 'hidden';
            }
        }
        
        // 页面加载完成后添加遮罩层点击事件
        document.addEventListener('DOMContentLoaded', function() {
            const overlay = document.getElementById('overlay');
            if (overlay) {
                overlay.addEventListener('click', (e) => {
                    // 只有点击遮罩层本身时才关闭模态框
                    if (e.target === overlay) {
                        toggleAuthModal(false);
                    }
                });
            }
        });
        
        // 切换登录/注册标签
        function switchAuthTab(tabName) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (!loginTab || !registerTab || !loginForm || !registerForm) return;
            
            if (tabName === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                registerTab.classList.add('active');
                loginTab.classList.remove('active');
                registerForm.style.display = 'block';
                loginForm.style.display = 'none';
            }
        }
        
        // 获取Cookie
        function getCookie(name) {
            const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
            if (match) return match[2];
            return null;
        }
        
        // 设置Cookie
        function setCookie(name, value, days = 7) {
            const expires = new Date();
            expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
            document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
        }
        
        // 登录表单提交
        async function submitLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const submitBtn = document.getElementById('loginSubmit');
            
            if (!username || !password) {
                showMessage('用户名和密码不能为空', true);
                return;
            }
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = '登录中...';
                
                const response = await fetch(`${API_BASE}/api/users/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                if (result.code === 200) {
                    // 保存token到localStorage
                    if (result.data.token) {
                        localStorage.setItem('authToken', result.data.token);
                    }
                    showMessage('登录成功');
                    toggleAuthModal(false);
                    await checkLoginStatus();
                } else {
                    throw new Error(result.msg || '登录失败');
                }
            } catch (error) {
                showMessage('登录失败: ' + error.message, true);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '登录';
            }
        }
        
        // 注册表单提交
        async function submitRegister() {
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const nickname = document.getElementById('registerNickname').value.trim();
            const submitBtn = document.getElementById('registerSubmit');
            
            if (!username || !password) {
                showMessage('用户名和密码不能为空', true);
                return;
            }
            
            if (password.length < 6) {
                showMessage('密码长度至少为6位', true);
                return;
            }
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = '注册中...';
                
                const response = await fetch(`${API_BASE}/api/users/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ username, password, nickname })
                });
                
                const result = await response.json();
                if (result.code === 200) {
                    showMessage('注册成功，即将自动登录');
                    setTimeout(() => {
                        toggleAuthModal(false);
                        checkLoginStatus();
                    }, 1500);
                } else {
                    throw new Error(result.msg || '注册失败');
                }
            } catch (error) {
                showMessage('注册失败: ' + error.message, true);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '注册';
            }
        }
        
        // 退出登录
        async function logout() {
            try {
                // 从localStorage获取token
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/api/users/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });
                
                // 清除localStorage中的token
                localStorage.removeItem('authToken');
                currentUser = null;
                updateAuthUI();
                showMessage('已退出登录');
            } catch (error) {
                // 无论如何都清除token
                localStorage.removeItem('authToken');
                currentUser = null;
                updateAuthUI();
                showMessage('已退出登录');
            }
        }
        
        // 提交评论
        async function submitComment() {
            const input = document.getElementById('commentInput');
            const content = input.value.trim();
            const submitBtn = document.querySelector('.comment-submit');
            
            // 检查用户是否登录
            if (!currentUser) {
                showMessage('请先登录后再评论');
                toggleAuthModal(true, 'login');
                return;
            }
            
            if (!content) {
                showMessage('评论内容不能为空', true);
                return;
            }
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = '发布中...';
                
                // 从localStorage获取token
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/api/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify({
                        video_id: videoId,
                        content: content
                    })
                });
                
                const result = await response.json();
                if (result.code === 200) {
                    input.value = '';
                    showMessage('评论发布成功');
                    // 重新加载评论
                    await loadComments();
                } else {
                    throw new Error(result.msg);
                }
            } catch (error) {
                showMessage('评论发布失败: ' + error.message, true);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '评论';
            }
        }
        
        // 提交弹幕
        async function sendDanmu() {
            const input = document.getElementById('danmuInput');
            const content = input.value.trim();
            const sendBtn = document.querySelector('.danmu-send');
            const videoPlayer = document.getElementById('videoPlayer');
            
            // 检查用户是否登录
            if (!currentUser) {
                showMessage('请先登录后再发送弹幕');
                toggleAuthModal(true, 'login');
                return;
            }
            
            if (!content || content.length > 50) {
                showMessage('弹幕内容不能为空且不超过50个字符', true);
                return;
            }
            
            try {
                sendBtn.disabled = true;
                sendBtn.textContent = '发送中...';
                
                const time = player ? player.currentTime() : 0;
                
                // 从localStorage获取token
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/api/danmus`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify({
                        video_id: videoId,
                        content: content,
                        time: time,
                        color: selectedDanmuColor
                    })
                });
                
                const result = await response.json();
                if (result.code === 200) {
                    input.value = '';
                    showMessage('弹幕发送成功');
                    
                    // 立即显示新发送的弹幕
                    const newDanmu = {
                        id: ++danmuIdCounter,
                        content: content,
                        time: time,
                        color: '#fff',
                        created_at: new Date().toISOString()
                    };
                    danmus.push(newDanmu);
                    showDanmuItem(newDanmu);
                } else {
                    throw new Error(result.msg);
                }
            } catch (error) {
                showMessage('弹幕发送失败: ' + error.message, true);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = '发送';
            }
        }

        // 显示消息提示
        function showMessage(text, isError = false) {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = isError ? 'message error' : 'message';
            message.style.display = 'block';
            
            setTimeout(() => {
                message.style.display = 'none';
            }, 3000);
        }

        // HTML转义函数，防止XSS攻击
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 页面加载初始化
        window.addEventListener('DOMContentLoaded', function() {
            // 立即检查登录状态，确保UI正确显示
            checkLoginStatus();
            
            // 添加模态框相关事件监听
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            
            if (loginTab) loginTab.addEventListener('click', function() { switchAuthTab('login'); });
            if (registerTab) registerTab.addEventListener('click', function() { switchAuthTab('register'); });
            
            // 延迟初始化播放器，确保Video.js完全加载
            setTimeout(function() {
                // 再次检查Video.js是否加载成功
                if (typeof videojs === 'undefined') {
                    console.warn('Video.js 仍未加载，尝试使用原生video元素');
                    // 使用原生video元素作为回退
                    initNativeVideoPlayer();
                } else {
                    // 使用Video.js初始化
                    initPlayer();
                }
            }, 1000);
        });
        
        // 原生video播放器初始化（作为Video.js的回退方案）
        function initNativeVideoPlayer() {
            console.log('使用原生video播放器作为回退');
            const videoElement = document.getElementById('videoPlayer');
            if (videoElement) {
                // 确保video元素没有被Video.js修改
                if (videoElement.classList.contains('vjs-tech')) {
                    // 如果已经被Video.js修改，创建一个新的video元素
                    const newVideo = document.createElement('video');
                    newVideo.id = 'videoPlayer';
                    newVideo.className = 'video-js vjs-default-skin';
                    newVideo.controls = true;
                    newVideo.style.width = '100%';
                    newVideo.style.height = '100%';
                    videoElement.parentNode.replaceChild(newVideo, videoElement);
                }
                
                // 设置video元素样式
                videoElement.style.width = '100%';
                videoElement.style.height = '100%';
                videoElement.style.objectFit = 'contain';
                videoElement.controls = true;
                
                // 模拟player对象，以便现有代码能正常工作
                window.player = {
                    currentTime: function() { return videoElement.currentTime; },
                    src: function(src) { videoElement.src = src; },
                    load: function() { videoElement.load(); },
                    on: function(event, callback) {
                        videoElement.addEventListener(event, callback);
                    },
                    ready: function(callback) {
                        if (videoElement.readyState >= 2) {
                            callback();
                        } else {
                            videoElement.addEventListener('canplay', callback);
                        }
                    },
                    play: function() { return videoElement.play(); },
                    pause: function() { videoElement.pause(); },
                    paused: function() { return videoElement.paused; },
                    muted: function() { return videoElement.muted; },
                    volume: function(vol) {
                        if (vol !== undefined) {
                            videoElement.volume = vol;
                            return this;
                        }
                        return videoElement.volume;
                    }
                };
                
                // 监听时间更新以显示弹幕
                videoElement.addEventListener('timeupdate', showDanmus);
                
                // 如果已有视频数据，加载视频
                if (window.videoData && window.videoData.video_path) {
                    videoElement.src = window.videoData.video_path;
                    videoElement.load();
                }
            }
        }
        
        // Video.js会自动处理视频错误事件，在initVideoPlayer函数中添加错误处理
        
        // 视频解码准备好事件
        // Video.js会自动处理尺寸调整和播放事件
        
        // 检测原生播放器接管和处理移动设备兼容性
        function detectPlayerMode() {
            const videoPlayer = document.getElementById('videoPlayer');
            const nativeNotice = document.getElementById('nativePlayerNotice');
            const danmuContainer = document.getElementById('danmuContainer');
            
            // 检测是否为移动设备
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // 在移动设备上，尝试保持弹幕容器的可见性
                danmuContainer.style.pointerEvents = 'none';
                danmuContainer.style.zIndex = '2147483647'; // 最高层级
                
                // 调整弹幕大小以适应移动设备
                adjustDanmuSizeForMobile();
                
                // 添加延迟检查，避免过早判断播放器被接管
                setTimeout(() => {
                    // Video.js处理移动设备兼容性
                }, 1000);
                
                // Video.js会自动处理播放事件
            }
        }
        
        // Video.js会自动处理移动设备兼容性和播放器接管问题
        
        // 为移动设备调整弹幕大小
        function adjustDanmuSizeForMobile() {
            const style = document.createElement('style');
            style.textContent = `
                .danmu-item {
                    font-size: 16px !important;
                    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
                }
                @media (max-width: 480px) {
                    .danmu-item {
                        font-size: 14px !important;
                    }
                }
            `;
            document.head.appendChild(style);
        }
        

        
        // 初始化播放器兼容性功能
        function initPlayerCompatibility() {
            // 所有浏览器都使用自定义播放器
            console.log('所有浏览器使用自定义播放器');
            
            // 隐藏原生播放器接管提示
            const nativeNotice = document.getElementById('nativePlayerNotice');
            if (nativeNotice) {
                nativeNotice.style.display = 'none';
            }
            
            // Video.js会自动处理视频元素的设置
            
            // 初始化Video.js播放器
            initVideoPlayer();
            
            // 添加窗口大小变化监听
            window.addEventListener('resize', function() {
                // Video.js会自动处理尺寸调整
                
                const danmuContainer = document.getElementById('danmuContainer');
                const videoWrapper = document.querySelector('.video-wrapper');
                
                if (danmuContainer && videoWrapper) {
                    const rect = videoWrapper.getBoundingClientRect();
                    danmuContainer.style.width = rect.width + 'px';
                    danmuContainer.style.height = rect.height + 'px';
                }
            });
            
            // 调整弹幕容器样式，确保在Canvas上方
            const danmuContainer = document.getElementById('danmuContainer');
            if (danmuContainer) {
                danmuContainer.style.pointerEvents = 'none';
                danmuContainer.style.zIndex = '2147483647'; // 最高层级
            }
            
            // 调整弹幕大小以适应移动设备
            adjustDanmuSizeForMobile();
        }
        
        // 移除重复的DOMContentLoaded事件监听器，兼容性功能已在initPlayer中初始化
    </script>
</body>
</html>